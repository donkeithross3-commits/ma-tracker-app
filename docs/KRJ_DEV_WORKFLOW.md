# KRJ Development & Deployment Workflow

**Quick reference for KRJ dashboard development and deployment**

---

## Local Development (Mac)

### Prerequisites
- Node.js 22+
- npm installed
- `data/krj/` directory with CSV files and metadata.json

### Testing Changes Locally

```bash
# Navigate to project
cd /Users/donaldross/dev/ma-tracker-app

# 1. Verify metadata exists
cat data/krj/metadata.json
# Should show: "signal_date": "2025-12-19"

# 2. Clean build (IMPORTANT - clears cache)
rm -rf .next && npm run build

# 3. Start production server
npm start

# 4. Test in browser
open http://localhost:3000/krj
# Verify date shows "Dec 19, 2025" (or current Friday)

# 5. Stop server when done
pkill -f "node.*next.*start"
```

### Key Files to Know

| File | Purpose | Notes |
|------|---------|-------|
| `app/krj/page.tsx` | KRJ dashboard UI | Must have `export const dynamic = 'force-dynamic'` |
| `data/krj/metadata.json` | Signal date metadata | Generated by batch script |
| `data/krj/latest_*.csv` | CSV data files | Copied by batch script |
| `scripts/run_krj_batch.py` | Batch script | Reference implementation |
| `middleware.ts` | Basic auth | Protects `/krj` route |

---

## Production Deployment (Droplet)

### Server Info
- **Host:** 134.199.204.12 (dr3-ma-dev)
- **User:** don
- **Path:** /home/don/apps
- **Access:** `ssh don@134.199.204.12`

### Deployment Process

```bash
# 1. TEST LOCALLY FIRST (see above)

# 2. Deploy files to droplet
cd /Users/donaldross/dev/ma-tracker-app
DROPLET_IP=134.199.204.12 ./deploy-krj-date-fix.sh

# 3. SSH to droplet
ssh don@134.199.204.12

# 4. Rebuild Docker image
cd /home/don/apps/ma-tracker-app
docker build -t ma-tracker-app-dev -f Dockerfile .

# 5. Restart web container
cd /home/don/apps
docker compose restart web

# 6. Verify deployment
curl -s http://134.199.204.12:3000/krj | grep -o 'Dec [0-9]*, 2025'
# Should output: Dec 19, 2025

# 7. Check logs if needed
docker compose logs web --tail 50
```

### Quick Commands

```bash
# View running containers
docker compose ps

# Restart web service
docker compose restart web

# View logs
docker compose logs web -f

# Check metadata file
cat /home/don/apps/data/krj/metadata.json

# Verify code in container
docker compose exec web cat /app/app/krj/page.tsx | head -20
```

---

## Batch Script Workflow

### Current State (Manual)

```bash
# On local machine: Generate signals
cd ~/Documents/daily_data
# Run KRJ backtester → creates KRJ_signals_latest_week_*_2025-12-19.csv

# Sync to droplet
rsync -avz ~/Documents/daily_data/ don@134.199.204.12:/home/don/apps/py_proj/daily_data/

# On droplet: Run batch script
ssh don@134.199.204.12
cd /home/don/apps
docker compose run --rm krj-batch
```

### Future State (Automated - TODO)

```bash
# Cron job on droplet (Saturday 8 AM)
0 8 * * 6 cd /home/don/apps && docker compose run --rm krj-batch
```

---

## Troubleshooting

### Problem: UI shows wrong date

**Symptoms:** UI displays "Dec 12, 2025" or file modification date instead of Friday signal date

**Solution:**
```bash
# 1. Check metadata exists
cat data/krj/metadata.json  # Local
ssh don@134.199.204.12 "cat /home/don/apps/data/krj/metadata.json"  # Droplet

# 2. Verify page.tsx has dynamic rendering
grep "export const dynamic" app/krj/page.tsx
# Should show: export const dynamic = 'force-dynamic';

# 3. Clear cache and rebuild
rm -rf .next && npm run build  # Local
# On droplet: rebuild Docker image (see deployment steps)

# 4. Hard refresh browser (Cmd+Shift+R)
```

### Problem: Changes not appearing after deployment

**Symptoms:** Code changes visible in files but not in running app

**Solution:**
```bash
# 1. Verify files synced
ssh don@134.199.204.12 "cat /home/don/apps/ma-tracker-app/app/krj/page.tsx | head -20"

# 2. Rebuild Docker image (CRITICAL)
ssh don@134.199.204.12
cd /home/don/apps/ma-tracker-app
docker build -t ma-tracker-app-dev -f Dockerfile .

# 3. Restart container
cd /home/don/apps
docker compose restart web

# 4. Verify container has new code
docker compose exec web cat /app/app/krj/page.tsx | head -20
```

### Problem: metadata.json not being generated

**Symptoms:** Batch script runs but metadata.json doesn't exist

**Solution:**
```bash
# 1. Check batch script version
ssh don@134.199.204.12 "head -30 /home/don/apps/py_proj/run_krj_batch.py"
# Should mention "metadata generation"

# 2. Check Docker image has new script
ssh don@134.199.204.12
cd /home/don/apps
docker compose run --rm --entrypoint head krj-batch /app/run_krj_batch.py -30

# 3. Rebuild krj-batch image if needed
cd /home/don/apps/py_proj
docker build -t krj-batch -f Dockerfile .

# 4. Run batch script
cd /home/don/apps
docker compose run --rm krj-batch
```

---

## Checklist: Before Deploying

- [ ] Changes tested locally with `npm start`
- [ ] UI shows correct date (e.g., "Dec 19, 2025")
- [ ] No console errors in browser
- [ ] Data table loads correctly
- [ ] `metadata.json` exists with correct date
- [ ] `export const dynamic = 'force-dynamic'` present in page.tsx
- [ ] Git commit created with descriptive message

## Checklist: After Deploying

- [ ] Files synced to droplet
- [ ] Docker image rebuilt
- [ ] Web container restarted
- [ ] UI accessible at http://134.199.204.12:3000/krj
- [ ] Correct date displayed
- [ ] No errors in Docker logs
- [ ] Basic auth still working

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│ Local Mac Development                                       │
│                                                             │
│  KRJ Backtester                                            │
│       ↓                                                     │
│  KRJ_signals_latest_week_Equities_2025-12-19.csv          │
│       ↓                                                     │
│  rsync to droplet                                          │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ DigitalOcean Droplet (134.199.204.12)                     │
│                                                             │
│  /home/don/apps/py_proj/daily_data/                       │
│       ↓                                                     │
│  run_krj_batch.py (Docker: krj-batch)                     │
│       ├─ Parses filename → extracts "2025-12-19"          │
│       ├─ Copies to data/krj/latest_*.csv                  │
│       └─ Generates data/krj/metadata.json                  │
│                                                             │
│  Next.js App (Docker: ma-tracker-app-web)                 │
│       ├─ Reads data/krj/metadata.json                      │
│       ├─ Reads data/krj/latest_*.csv                       │
│       └─ Serves http://134.199.204.12:3000/krj            │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ Browser                                                     │
│                                                             │
│  http://134.199.204.12:3000/krj                           │
│  → Shows "KRJ Weekly Signals - Dec 19, 2025"              │
└─────────────────────────────────────────────────────────────┘
```

---

## Important Notes

1. **Always test locally before deploying** - Catch issues early
2. **Docker images must be rebuilt** - Code changes don't auto-sync
3. **metadata.json is critical** - Without it, UI shows wrong date
4. **Dynamic rendering required** - Static pages cache stale dates
5. **No downtime deployment** - Web service can restart independently

---

*Last updated: 2025-12-25*
*See also: DEPLOYMENT_KRJ.md, KRJ_DATE_FIX_DEPLOYMENT_REPORT.md*

