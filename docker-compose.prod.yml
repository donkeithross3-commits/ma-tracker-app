version: '3.8'

services:
  web:
    build:
      context: ./ma-tracker-app
      dockerfile: Dockerfile.prod
    image: ma-tracker-app-prod:latest
    container_name: ma-tracker-app-web
    ports:
      - "3000:3000"
    volumes:
      # KRJ data directory - writable for on-demand signals
      # CRITICAL: This path must not change - KRJ data flow depends on it
      - ./data/krj:/app/data/krj
    # So the container can reach the host (where Python runs on port 8000)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=production
      # Next.js standalone binds to HOSTNAME; must be 0.0.0.0 for port forwarding
      - HOSTNAME=0.0.0.0
      # Dashboard must reach Python service on host (relay, IB status, options, etc.)
      - PYTHON_SERVICE_URL=http://host.docker.internal:8000
      # Portfolio service runs in its own container on the frontend network
      - PORTFOLIO_SERVICE_URL=http://python-portfolio:8001
    # Load environment variables from .env.local
    # Must contain: KRJ_BASIC_USER, KRJ_BASIC_PASS, DATABASE_URL
    env_file:
      - ./ma-tracker-app/.env.local
    networks:
      - frontend
      - default
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  python-portfolio:
    build:
      context: ./ma-tracker-app/python-service
      dockerfile: Dockerfile.portfolio
    image: python-portfolio:latest
    container_name: python-portfolio
    # No host port exposure â€” only reachable from the frontend network
    env_file:
      - ./ma-tracker-app/python-service/.env
    environment:
      - CORS_ALLOWED_ORIGINS=https://dr3-dashboard.com,http://localhost:3000
      # Override localhost with Docker network hostname for postgres container
      - DATABASE_URL=postgresql://ma_user:ma_password_2025@postgres:5432/ma_tracker
    networks:
      - frontend
      - default
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  krj-batch:
    build:
      context: ./py_proj
      dockerfile: Dockerfile
    image: krj-batch:latest
    container_name: krj-batch
    volumes:
      # Output directory - write access
      # CRITICAL: This path must not change - KRJ data flow depends on it
      - ./data/krj:/data/krj
      # Input directory - read-only for safety
      # CRITICAL: This path must not change - KRJ data flow depends on it
      - ./py_proj/daily_data:/root/Documents/daily_data:ro
    environment:
      - KRJ_DATA_DIR=/root/Documents/daily_data
      - KRJ_OUTPUT_DIR=/data/krj
    restart: "no"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

networks:
  frontend:
    driver: bridge
