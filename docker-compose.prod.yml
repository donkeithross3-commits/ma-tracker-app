version: '3.8'

services:
  web:
    build:
      context: ./ma-tracker-app
      dockerfile: Dockerfile.prod
    image: ma-tracker-app-prod:latest
    container_name: ma-tracker-app-web
    ports:
      - "3000:3000"
    volumes:
      # KRJ data directory - writable for on-demand signals
      # CRITICAL: This path must not change - KRJ data flow depends on it
      - ./data/krj:/app/data/krj
      # Standalone agent bundle - served via volume mount for zero-downtime updates.
      # Agent code changes only need `git pull` on host — no image rebuild required.
      - ./ma-tracker-app/python-service/standalone_agent:/app/python-service/standalone_agent:ro
    # So the container can reach the host (where Python runs on port 8000)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=production
      # Next.js standalone binds to HOSTNAME; must be 0.0.0.0 for port forwarding
      - HOSTNAME=0.0.0.0
      # Dashboard must reach Python service on host (relay, IB status, options, etc.)
      - PYTHON_SERVICE_URL=http://host.docker.internal:8000
      # Portfolio service runs in its own container on the frontend network
      - PORTFOLIO_SERVICE_URL=http://python-portfolio:8001
    # Load environment variables from .env.local
    # Must contain: KRJ_BASIC_USER, KRJ_BASIC_PASS, DATABASE_URL
    env_file:
      - ./ma-tracker-app/.env.local
    networks:
      - frontend
      - default
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  python-portfolio:
    build:
      context: ./ma-tracker-app/python-service
      dockerfile: Dockerfile.portfolio
    image: python-portfolio:latest
    container_name: python-portfolio
    # No host port exposure — only reachable from the frontend network
    env_file:
      - ./ma-tracker-app/python-service/.env
    environment:
      - CORS_ALLOWED_ORIGINS=https://dr3-dashboard.com,http://localhost:3000
      # Override localhost with Docker network hostname for postgres container
      - DATABASE_URL=postgresql://ma_user:ma_password_2025@postgres:5432/ma_tracker
      # --- Scheduler & Messaging env vars (set in .env or override here) ---
      # SENDGRID_API_KEY=SG...
      # SENDGRID_FROM_EMAIL=alerts@ma-tracker.com
      # WHATSAPP_API_KEY=...
      # WHATSAPP_PHONE_NUMBER=...
      # ALERT_EMAIL_RECIPIENTS=user@example.com (comma-separated)
      # ALERT_WHATSAPP_RECIPIENTS=+1234567890 (comma-separated)
      # ANTHROPIC_API_KEY=sk-ant-...
      # POLYGON_API_KEY=...
      # SCHEDULER_TIMEZONE=US/Eastern
      # SPREAD_ALERT_THRESHOLD_PCT=2.0
      # MORNING_REPORT_HOUR=7
      # MORNING_REPORT_MINUTE=0
    networks:
      - frontend
      - default
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  krj-batch:
    build:
      context: ./py_proj
      dockerfile: Dockerfile
    image: krj-batch:latest
    container_name: krj-batch
    volumes:
      # Output directory - write access
      # CRITICAL: This path must not change - KRJ data flow depends on it
      - ./data/krj:/data/krj
      # Input directory - read-only for safety
      # CRITICAL: This path must not change - KRJ data flow depends on it
      - ./py_proj/daily_data:/root/Documents/daily_data:ro
    environment:
      - KRJ_DATA_DIR=/root/Documents/daily_data
      - KRJ_OUTPUT_DIR=/data/krj
    restart: "no"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  postgres:
    image: postgres:16-alpine
    container_name: ma-tracker-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ma_user
      POSTGRES_PASSWORD: ma_password_2025
      POSTGRES_DB: ma_tracker
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    deploy:
      resources:
        limits:
          memory: 1g
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ma_user -d ma_tracker"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

networks:
  frontend:
    driver: bridge

volumes:
  postgres_data:
