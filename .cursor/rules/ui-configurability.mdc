---
description: UI configurability architecture — column chooser, comfort mode, preferences context
alwaysApply: true
---

# UI Configurability Architecture

## Philosophy

Two users with opposite needs use the same dashboard:
- **Compact / Power User**: wants maximum data density, many columns visible, small padding.
  This is the default mode. KRJ signals page is the reference implementation.
- **Comfort / Accessible User**: has Parkinson's, needs larger touch targets (44px min),
  bigger text, more padding. IBPositionsTab (trade buttons, position boxes) is the reference.

Each screen has a **native density** — it was originally designed for one user type.
The Comfort Mode toggle provides an optimized alternate view, not a uniform scale.

Key design rules:
- **Never auto-hide columns.** If content overflows, shrink font/padding fluidly. The user
  decides which columns to remove via the Column Chooser.
- **Comfort mode must scale intelligently** with screen width and visible column count.
  Fixed breakpoints break on external monitors / varying column selections.
- **Keep the system lightweight.** One JSONB column, one React context, one CSS density layer.
  No per-table persistence endpoints, no database migrations for new tables.

## System Components

### 1. Database Layer

Single JSONB column on `user_preferences`:
```sql
ALTER TABLE user_preferences ADD COLUMN ui_prefs JSONB DEFAULT '{}';
```

Schema in `prisma/schema.prisma`:
```prisma
uiPrefs Json? @map("ui_prefs")
```

Shape of `uiPrefs`:
```typescript
interface UIPrefs {
  densityMode?: "compact" | "comfort" | null   // null = compact (default)
  columnVisibility?: {
    [tableKey: string]: string[]  // ordered array of visible column keys
  }
}
```

Adding a new table's columns requires NO migration — just use a new key in `columnVisibility`.

### 2. API Layer

`/api/user/preferences` (GET / PUT) — existing endpoint extended with `uiPrefs` field.
All preference categories (maOptionsPrefs, dealListPrefs, uiPrefs, customTickers) are
fetched in one call and persisted atomically via upsert.

### 3. React Context — `UIPreferencesProvider`

**File:** `lib/ui-preferences.tsx`

Wraps the app in `app/layout.tsx` inside `<SessionProvider>`. Provides:
- `prefs` / `loaded` — full preferences object and loading state
- `isComfort` / `toggleDensity()` — density mode state and toggle
- `getVisibleColumns(pageKey)` — returns `string[] | null` (null = use defaults)
- `setVisibleColumns(pageKey, columns)` — persists column selection
- `updatePrefs(partial)` — generic deep-merge for any preference category

**Persistence strategy:**
- All updates are debounced (600ms) to avoid chatty API calls
- On unmount / navigation, `sendBeacon` flushes any pending save
- Single source of truth — eliminates read-modify-write race conditions

**Density attribute:**
- Sets `data-density="comfort"` on `<html>` immediately on state change
- CSS custom properties in `globals.css` respond to this attribute

### 4. CSS Density System

**File:** `app/globals.css`

Two tiers of CSS custom properties:
```
:root                        → compact defaults (KRJ-calibrated)
[data-density="comfort"]     → comfort overrides (IB Positions-calibrated)
```

Variables: `--d-table-py`, `--d-table-px`, `--d-table-font`, `--d-header-font`,
`--d-row-min-h`, `--d-btn-*`, `--d-action-btn-*`, `--d-section-gap`, `--d-card-*`

**Fluid table scaling (comfort mode only):**
```css
.d-table-wrap { container-type: inline-size; }

[data-density="comfort"] .d-table th,
[data-density="comfort"] .d-table td {
  font-size: clamp(0.875rem, calc(100cqi / var(--visible-cols, 15) / 6), 1.375rem);
  /* similar clamp() for padding */
}
```

Tables opt in by:
1. Wrapping in `<div className="d-table-wrap" style={{ "--visible-cols": N }}>`
2. Adding `className="d-table"` to the `<table>`

The `--visible-cols` CSS variable is set by React from the length of the visible columns
array, enabling font/padding to scale proportionally as columns are added/removed.

### 5. ColumnChooser Component

**File:** `components/ui/ColumnChooser.tsx`

Fully generic, reusable Radix dropdown with checkboxes. Props:
- `columns: ColumnDef[]` — all available columns (key + label)
- `visible: string[]` — currently visible keys (order-preserved)
- `defaults: string[]` — default set (used by "Reset to defaults" action)
- `onChange: (keys: string[]) => void` — callback when visibility changes
- `locked?: string[]` — columns that cannot be hidden (greyed out checkbox)
- `size?: "sm" | "md"` — button size variant

Behavior:
- Toggling a column inserts it at its position in the master column order
- Cannot hide all columns (at least 1 must remain)
- "Reset to defaults" button appears only when current differs from defaults
- Menu stays open on toggle (onSelect preventDefault)

### 6. Comfort Mode Toggle

**File:** `components/UserMenu.tsx`

A switch in the user menu dropdown. Uses `useUIPreferences()` for `isComfort` and
`toggleDensity`. Available on every page since UserMenu is in the global header.

## Adding Column Chooser to a New Table — Step by Step

```typescript
// 1. Import
import { ColumnChooser, type ColumnDef } from "@/components/ui/ColumnChooser";
import { useUIPreferences } from "@/lib/ui-preferences";

// 2. Define columns outside the component (module-level constants)
const MY_COLUMNS: ColumnDef[] = [
  { key: "ticker", label: "Ticker" },
  { key: "price", label: "Price" },
  { key: "volume", label: "Volume" },
  // ...
];
const MY_DEFAULTS = MY_COLUMNS.map(c => c.key);  // or a subset
const MY_LOCKED = ["ticker"];  // can't be hidden

// 3. Inside the component
const { getVisibleColumns, setVisibleColumns } = useUIPreferences();
const savedCols = getVisibleColumns("myTableKey");
const visibleKeys = useMemo(() => savedCols ?? MY_DEFAULTS, [savedCols]);
const visibleSet = useMemo(() => new Set(visibleKeys), [visibleKeys]);
const handleColsChange = useCallback(
  (keys: string[]) => setVisibleColumns("myTableKey", keys),
  [setVisibleColumns]
);

// 4. Render the chooser (typically in a header/toolbar area)
<ColumnChooser
  columns={MY_COLUMNS}
  visible={visibleKeys}
  defaults={MY_DEFAULTS}
  onChange={handleColsChange}
  locked={MY_LOCKED}
/>

// 5. Wrap the table for comfort-mode fluid scaling
<div className="overflow-x-auto d-table-wrap"
     style={{ "--visible-cols": visibleKeys.length } as React.CSSProperties}>
  <table className="w-full text-sm d-table">
    <thead>
      <tr>
        {visibleSet.has("ticker") && <th>Ticker</th>}
        {visibleSet.has("price") && <th>Price</th>}
        {/* ... */}
      </tr>
    </thead>
    <tbody>
      {rows.map(row => (
        <tr key={row.id}>
          {visibleSet.has("ticker") && <td>{row.ticker}</td>}
          {visibleSet.has("price") && <td>{row.price}</td>}
          {/* ... */}
        </tr>
      ))}
    </tbody>
  </table>
</div>
```

## Tables with Column Choosers (current inventory)

| Table Key            | Component                        | Page/Tab           | Locked Columns       |
|----------------------|----------------------------------|--------------------|----------------------|
| `krj`                | KrjTabsClient                    | /krj               | ticker               |
| `watchedSpreads`     | WatchedSpreadsTable              | M&A Options Monitor| ticker               |
| `candidateStrategies`| CandidateStrategiesTable         | M&A Options Curator| ticker               |
| `optionChain`        | OptionChainViewer                | M&A Options Curator| strike               |
| `dealSelector`       | ScannerDealSelector              | M&A Options Curator| ticker, actions      |
| `ibPositions`        | IBPositionsTab (positions)       | M&A Options Account| symbol, trade        |
| `ibOrders`           | IBPositionsTab (working orders)  | M&A Options Account| symbol, action       |

## Strategy Sub-Columns (Shared)

`StrategyColumns.tsx` exports shared header/cell components used by both
WatchedSpreadsTable and CandidateStrategiesTable. These accept an optional
`visibleCols?: Set<string>` prop. When undefined, all columns render
(backward-compatible). The strategy column keys are:
`strikes`, `legPrices`, `market`, `midEntry`, `farEntry`

The `midEntry` and `farEntry` groups are treated as atomic units — each controls
3 sub-columns (Cost, Profit, IRR) together. The `colSpan` for their grouped
header row dynamically counts visible sub-columns.

## Print Layout Integration

`KrjPrintLayout` accepts `visibleColumns` and only renders columns the user has
selected. Column abbreviations and formatting are handled within the print layout
to keep printed output readable at any column count.

When adding print support to other tables, follow the same pattern: pass the
visible column set to the print component and filter accordingly.

## Gotchas and Lessons Learned

1. **The `ColumnChooser` is a named export**, not a default export.
   Use: `import { ColumnChooser, type ColumnDef } from "@/components/ui/ColumnChooser"`

2. **Always define column constants at module level**, not inside the component.
   This avoids re-creating arrays on every render and prevents infinite loops with
   `useMemo` dependencies.

3. **`colSpan` in grouped headers must be dynamic.** If a table has grouped headers
   (e.g. "Midpoint Entry" spanning Cost/Profit/IRR), compute colSpan by counting
   how many sub-columns are visible: `colSpan={["cost","profit","irr"].filter(k => visibleSet.has(k)).length}`

4. **Footer/totals `colSpan` must also be dynamic.** If the first N columns are
   spanned with "Totals", count how many of those are actually visible.

5. **Comfort mode CSS only activates on opted-in tables** — those with `d-table-wrap`
   and `d-table` classes. This means existing tables that haven't been converted yet
   are unaffected by the density toggle.

6. **Don't fight the fluid scaling.** In comfort mode, `clamp()` handles font sizing.
   Don't add fixed `text-xs` or `text-sm` classes to cells inside a `d-table` — they
   override the fluid values. Use them only in compact mode or on non-table elements.

7. **Position box persistence uses `updatePrefs` directly**, not `setVisibleColumns`.
   The IBPositionsTab's selected ticker boxes are stored in `maOptionsPrefs.selectedTickers`,
   not in `columnVisibility`. The column chooser is a separate concern from position
   box selection.
