# Security and Latency Non-Negotiables

These rules apply to ALL code changes in this repository.

## Security

- **Never log secrets.** Do not print, log, or expose API keys, database credentials, auth tokens, or their prefixes. Use `***` if you need to confirm a secret is set.
- **Never use `allow_origins=["*"]` in production.** CORS origins are configured via the `CORS_ALLOWED_ORIGINS` env var. Default: `https://dr3-dashboard.com,http://localhost:3000`.
- **Never commit real API keys or passwords** to source files, markdown docs, or comments. Use `<PLACEHOLDER>` or env vars.
- **Always validate ticker input.** Use `validate_ticker()` (in `options_routes.py`) for query params or the `_pydantic_ticker_validator` field_validator for Pydantic models. Tickers must match `^[A-Z]{1,10}$`.
- **Security headers are enabled by default** via `next.config.ts`. Disable with `ENABLE_SECURITY_HEADERS=false` only if debugging.

## Latency / Instrumentation

- **All IB relay endpoints must have `RequestTimer` instrumentation** (from `app/utils/timing.py`). Log `[perf]` lines with operation name, per-stage timing, and payload size.
- **Use `threading.Event` for IB data waits, not `time.sleep()`.** IB returns tick data via callbacks on a separate thread; `Event.wait(timeout=N)` exits instantly when the callback fires (typically 50-100ms) while still having a safety timeout. See `fetch_underlying_data` in `ib_scanner.py` as the reference pattern: set `self._underlying_done = Event()` before `reqMktData`, call `.wait(timeout=3.0)`, and `.set()` in `tickPrice` when the LAST price arrives.
- **Polling intervals** in React components must skip ticks when `document.hidden` to avoid wasting resources when the tab is backgrounded.
- **The `computeGroups()` call in `IBPositionsTab.tsx`** must be wrapped in `useMemo` keyed on `filteredPositions`.

## Feature Flags

When adding a security or performance change that could affect behaviour:
```python
# Python: env-var flags
FEATURE = os.environ.get("FEATURE_NAME", "default_value")
```
```typescript
// Next.js: env-var flags
const FEATURE = process.env.FEATURE_NAME !== "false"
```
