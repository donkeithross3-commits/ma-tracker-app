# ma-tracker-app rules

> Full agent contract: [docs/agent/AGENTS.md](docs/agent/AGENTS.md)
> Domain-specific rules: `.cursor/rules/*.mdc` (see AGENTS.md Section 3).

<!-- BEGIN SHARED BLOCK — DO NOT EDIT — source: docs/agent/SHARED_BLOCK.md -->
## Cross-Repo Agent Contract (Shared Block)

> **Canonical source:** `docs/agent/SHARED_BLOCK.md` in each repo.
> This block MUST appear identically in `.cursorrules` and `CLAUDE.md` in BOTH repos.
> Run `docs/agent/check_sync.sh` to verify sync. See `docs/agent/AGENTS.md` for full contract.

### Two-Repo System

This codebase is ONE HALF of a two-repo system. Both repos serve https://dr3-dashboard.com.

| Repo | Purpose | Branch | Language |
|------|---------|--------|----------|
| `ma-tracker-app` | Next.js dashboard, FastAPI backend, IB agent | `main` | TypeScript / Python |
| `py_proj` | KRJ backtester, market state pipelines, research | `cursor-dev` | Python |

**Shared infra:** Droplet `134.199.204.12` (SSH alias: `droplet`), Neon PostgreSQL, Docker.

### Multi-Device Sync

- Before ending a session, commit and push all changes.
- Use `pushall` to sync both repos before switching machines.
- Production domain: https://dr3-dashboard.com

### Security & Privacy

- **Never log, print, or commit secrets** (API keys, DB credentials, auth tokens). Use `***` to confirm a secret is set.
- **Never commit real API keys or passwords** to source files, markdown, or comments. Use `<PLACEHOLDER>` or env vars.
- **Never use `allow_origins=["*"]`** in production CORS config.
- **Validate all user input** at system boundaries (ticker symbols, query params, form data).
- **Do not expose internal paths, IPs, or infra details** in client-facing code or public docs.

### Release Notes (MANDATORY)

The dashboard has a continuous release notes system. Every user-visible change MUST be documented:

1. Create or update `release-notes/YYYY-MM-DD.json` in `ma-tracker-app` (see format in CLAUDE.md).
2. Generate screenshots with `python-service/tools/release_screenshots.py` when applicable.
3. Commit JSON + PNGs together. The changelog pages (`/changelog`) pick them up automatically.
4. **Never skip this step.** Users rely on the changelog to understand what changed.

### Agent Coordination

- **You are not the only agent working on this system.** Both Claude Code and Cursor work on these repos.
- Before making architectural changes, check for in-progress work in `.claude-session` or recent commits.
- Guidance changes that affect both repos must update BOTH copies of `SHARED_BLOCK.md` and re-embed.
- Repo-specific guidance stays in that repo's `.cursorrules` / `CLAUDE.md` only.
- Read `docs/agent/AGENTS.md` for the full contract including onboarding and change protocol.
<!-- END SHARED BLOCK -->

## Deployment (ALWAYS DO THIS AFTER CHANGES)

All deploys go through the flock-gated deploy script (mutual exclusion, memory checks, health verification):
```bash
# Full deploy (Docker rebuild):
ssh droplet 'DR3_AGENT=cursor bash ~/apps/scripts/deploy.sh web'

# Python-only deploy:
ssh droplet 'DR3_AGENT=cursor bash ~/apps/scripts/deploy.sh python-service'

# Portfolio container only:
ssh droplet 'DR3_AGENT=cursor bash ~/apps/scripts/deploy.sh portfolio'
```

**NEVER run raw `docker compose build` or `docker compose up` on the droplet.** deploy.sh enforces --no-cache, --force-recreate, git pull, and health checks automatically. If it fails with a lock error, another deploy is in progress — wait and retry.

## Domain Rules (`.cursor/rules/*.mdc`)

| File | When to Load |
|------|-------------|
| `execution-engine.mdc` | IB execution engine, strategy patterns, order management |
| `security-and-latency.mdc` | Security non-negotiables, RequestTimer, threading.Event |
| `ib-contract-resolution.mdc` | IB contract resolution, futures exchange mapping |
| `realtime-event-push.mdc` | Real-time account event push architecture |
| `ui-configurability.mdc` | Column chooser, comfort mode, CSS density system |
| `ib-tws-api-settings.mdc` | IB TWS API settings for agent connectivity |
| `push-and-deploy.mdc` | Auto-deploy on task completion |

## Framework

- **Next.js 16** with App Router. Prisma ORM for frontend, asyncpg for backend.
- `/app/krj/page.tsx`: Read-only KRJ signal viewer. Do not change CSV loading.
- `middleware.ts`: NextAuth v5 auth. Do not relax without instruction.
- Styling: Tailwind utility classes, dark high-contrast theme.

## Essential Constraints

- **Ticker input**: Every UI ticker field MUST use SEC EDGAR autocomplete (see `CLAUDE.md`).
- **UI density**: High-density trader dashboards. Minimize vertical space.
- **Column choosers**: Every data table gets one. No exceptions.
- **KRJ data**: Never overwrite `~/apps/data/krj/` during deploys.
- **IB waits**: Use `threading.Event`, not `time.sleep()`.
- **Cross-repo BMC**: 9 imports from py_proj in `strategies/big_move_convexity.py`. See CLAUDE.md.

## Key Commands

```bash
./dev-start.sh                    # Start dev services
npm run dev                       # Frontend only
cd python-service && source venv/bin/activate && python3 start_server.py  # Backend only
npm run db:push                   # Push Prisma schema
```
