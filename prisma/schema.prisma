// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String   // Hashed password
  fullName  String?  @map("full_name")
  role      String   @default("analyst") // analyst, admin, viewer
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  dealsCreated        Deal[]             @relation("DealsCreated")
  dealsUpdated        Deal[]             @relation("DealsUpdated")
  dealVersions        DealVersion[]
  portfolioPositions  PortfolioPosition[]
  dealSnapshots       DealSnapshot[]
  apiPriceFetches     ApiPriceFetch[]
  auditLogs           AuditLog[]
  stagedDealsReviewed StagedDeal[]

  @@map("users")
}

// ============================================================================
// DEALS (Core entity - one record per unique deal)
// ============================================================================

model Deal {
  id             String   @id @default(uuid()) @map("deal_id")
  ticker         String
  targetName     String?  @map("target_name")
  acquirorTicker String?  @map("acquiror_ticker")
  acquirorName   String?  @map("acquiror_name")
  status         String   @default("active") // active, closed, terminated, pending
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Intelligence System Tracking
  intelligenceDealId       String?   @map("intelligence_deal_id") // UUID from intelligence database
  lastIntelligenceSync     DateTime? @map("last_intelligence_sync")
  hasPendingSuggestions    Boolean   @default(false) @map("has_pending_suggestions")

  // Foreign Keys
  createdById String? @map("created_by")
  updatedById String? @map("updated_by")

  // Relations
  createdBy          User?                @relation("DealsCreated", fields: [createdById], references: [id])
  updatedBy          User?                @relation("DealsUpdated", fields: [updatedById], references: [id])
  versions           DealVersion[]
  prices             DealPrice[]
  cvrs               Cvr[]
  portfolioPositions PortfolioPosition[]
  snapshots          DealSnapshot[]
  secFilings         SecFiling[]
  researchReport     DealResearchReport?

  @@index([ticker])
  @@index([status])
  @@map("deals")
}

// ============================================================================
// DEAL VERSIONS (Version control - every update creates new version)
// ============================================================================

model DealVersion {
  id              String    @id @default(uuid()) @map("version_id")
  dealId          String    @map("deal_id")
  versionNumber   Int       @map("version_number")
  effectiveDate   DateTime  @default(now()) @map("effective_date")
  isCurrentVersion Boolean  @default(true) @map("is_current_version")

  // Deal Dates
  announcedDate      DateTime? @map("announced_date") @db.Date
  expectedCloseDate  DateTime? @map("expected_close_date") @db.Date
  outsideDate        DateTime? @map("outside_date") @db.Date

  // Deal Terms
  category           String?   @db.VarChar(50) // all_cash, cash_stock, cash_cvr, stock, non_binding_offer
  cashPerShare       Decimal?  @map("cash_per_share") @db.Decimal(10, 4)
  stockRatio         Decimal?  @map("stock_ratio") @db.Decimal(10, 6)
  dividendsOther     Decimal?  @map("dividends_other") @db.Decimal(10, 4)
  stressTestDiscount Decimal?  @map("stress_test_discount") @db.Decimal(5, 4)

  // Risk Assessments
  voteRisk    String? @map("vote_risk") @db.VarChar(20) // low, medium, high
  financeRisk String? @map("finance_risk") @db.VarChar(20) // low, medium, high
  legalRisk   String? @map("legal_risk") @db.VarChar(20) // low, medium, high

  // Calculated Metrics (from individual deal sheets)
  currentYield Decimal? @map("current_yield") @db.Decimal(10, 6) // Expected IRR from individual sheet C19

  // Investment Flags
  isInvestable    Boolean @default(false) @map("is_investable")
  investableNotes String? @map("investable_notes") @db.Text
  dealNotes       String? @map("deal_notes") @db.Text
  goShopEndDate   DateTime? @map("go_shop_end_date") @db.Date

  // Foreign Keys
  createdById String? @map("created_by")

  // Relations
  deal      Deal  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  createdBy User? @relation(fields: [createdById], references: [id])

  @@unique([dealId, versionNumber])
  @@index([dealId, isCurrentVersion])
  @@index([effectiveDate])
  @@map("deal_versions")
}

// ============================================================================
// DEAL PRICES (Time-series price data from Interactive Brokers API)
// ============================================================================

model DealPrice {
  id             String   @id @default(uuid()) @map("price_id")
  dealId         String   @map("deal_id")
  priceDate      DateTime @map("price_date") @db.Date
  targetPrice    Decimal  @map("target_price") @db.Decimal(10, 4)
  acquirorPrice  Decimal? @map("acquiror_price") @db.Decimal(10, 4)
  source         String   @default("interactive_brokers") @db.VarChar(50)
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([dealId, priceDate])
  @@index([dealId, priceDate(sort: Desc)])
  @@index([priceDate(sort: Desc)])
  @@map("deal_prices")
}

// ============================================================================
// CVRs (Contingent Value Rights - multiple per deal)
// ============================================================================

model Cvr {
  id              String    @id @default(uuid()) @map("cvr_id")
  dealId          String    @map("deal_id")
  cvrName         String?   @map("cvr_name") @db.VarChar(255)
  paymentAmount   Decimal   @map("payment_amount") @db.Decimal(10, 4)
  probability     Decimal   @default(0.50) @db.Decimal(3, 2) // 0.00 to 1.00
  paymentDeadline DateTime? @map("payment_deadline") @db.Date
  paymentStatus   String    @default("pending") @map("payment_status") @db.VarChar(50) // pending, paid, expired
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([paymentStatus])
  @@map("cvrs")
}

// ============================================================================
// PORTFOLIO POSITIONS (Actual positions taken)
// ============================================================================

model PortfolioPosition {
  id         String    @id @default(uuid()) @map("position_id")
  dealId     String    @map("deal_id")
  shares     Decimal   @db.Decimal(15, 4)
  entryDate  DateTime  @map("entry_date") @db.Date
  entryPrice Decimal   @map("entry_price") @db.Decimal(10, 4)
  exitDate   DateTime? @map("exit_date") @db.Date
  exitPrice  Decimal?  @map("exit_price") @db.Decimal(10, 4)
  status     String    @default("open") @db.VarChar(50) // open, closed
  notes      String?   @db.Text
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Foreign Keys
  createdById String? @map("created_by")

  // Relations
  deal      Deal            @relation(fields: [dealId], references: [id])
  createdBy User?           @relation(fields: [createdById], references: [id])
  snapshots DealSnapshot[]

  @@index([dealId])
  @@index([status])
  @@map("portfolio_positions")
}

// ============================================================================
// DEAL SNAPSHOTS (Memorialize calculated values at key decision points)
// ============================================================================

model DealSnapshot {
  id           String   @id @default(uuid()) @map("snapshot_id")
  dealId       String   @map("deal_id")
  snapshotType String   @map("snapshot_type") @db.VarChar(50) // entry_decision, exit_decision, monthly_review
  snapshotDate DateTime @default(now()) @map("snapshot_date")

  // Snapshot of prices at this moment
  targetPrice    Decimal? @map("target_price") @db.Decimal(10, 4)
  acquirorPrice  Decimal? @map("acquiror_price") @db.Decimal(10, 4)
  dealPrice      Decimal? @map("deal_price") @db.Decimal(10, 4)

  // Snapshot of calculated metrics
  grossSpread       Decimal? @map("gross_spread") @db.Decimal(10, 6)
  netSpread         Decimal? @map("net_spread") @db.Decimal(10, 6)
  daysToClose       Int?     @map("days_to_close")
  annualizedReturn  Decimal? @map("annualized_return") @db.Decimal(10, 6)
  projectedIrr      Decimal? @map("projected_irr") @db.Decimal(10, 6)

  // Snapshot of CVR NPV
  cvrTotalNpv Decimal? @map("cvr_total_npv") @db.Decimal(10, 4)

  // Context
  notes String? @db.Text

  // Foreign Keys
  createdById String? @map("created_by")
  positionId  String? @map("position_id")

  // Relations
  deal      Deal               @relation(fields: [dealId], references: [id])
  createdBy User?              @relation(fields: [createdById], references: [id])
  position  PortfolioPosition? @relation(fields: [positionId], references: [id])

  @@index([dealId])
  @@index([snapshotType])
  @@index([snapshotDate(sort: Desc)])
  @@map("deal_snapshots")
}

// ============================================================================
// API INTEGRATION TRACKING (Track price fetches from Interactive Brokers)
// ============================================================================

model ApiPriceFetch {
  id               String    @id @default(uuid()) @map("fetch_id")
  fetchDate        DateTime  @map("fetch_date") @db.Date
  ticker           String    @db.VarChar(10)
  fetchStatus      String?   @map("fetch_status") @db.VarChar(50) // success, failure, partial
  recordsFetched   Int       @default(0) @map("records_fetched")
  errorMessage     String?   @map("error_message") @db.Text
  fetchStartedAt   DateTime  @default(now()) @map("fetch_started_at")
  fetchCompletedAt DateTime? @map("fetch_completed_at")

  // Foreign Keys
  createdById String? @map("created_by")

  // Relations
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([fetchDate(sort: Desc)])
  @@index([ticker])
  @@map("api_price_fetches")
}

// ============================================================================
// AUDIT LOG (Track all data changes for compliance and debugging)
// ============================================================================

model AuditLog {
  id            String   @id @default(uuid()) @map("log_id")
  entityType    String   @map("entity_type") @db.VarChar(50) // cvr, deal, position, etc.
  entityId      String   @map("entity_id")
  action        String   @db.VarChar(20) // create, update, delete
  changedFields String?  @map("changed_fields") @db.Text // JSON of changed fields
  oldValues     String?  @map("old_values") @db.Text // JSON of old values
  newValues     String?  @map("new_values") @db.Text // JSON of new values
  createdAt     DateTime @default(now()) @map("created_at")

  // Foreign Keys
  createdById String? @map("created_by")

  // Relations
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@index([createdById])
  @@map("audit_logs")
}

// ============================================================================
// AI DEAL RESEARCH REPORTS
// ============================================================================

// SEC Filings tracking (proxies, merger agreements, 8-Ks, etc.)
model SecFiling {
  id               String    @id @default(uuid()) @map("filing_id")
  dealId           String    @map("deal_id")
  filingType       String    @map("filing_type") @db.VarChar(20) // DEFM14A, 8-K, DEFA14A, etc.
  filingDate       DateTime  @map("filing_date") @db.Date
  accessionNumber  String    @map("accession_number") @db.VarChar(50) // SEC accession number
  edgarUrl         String    @map("edgar_url") @db.Text // Full URL to filing on EDGAR
  documentUrl      String?   @map("document_url") @db.Text // Direct URL to primary document
  htmlText         String?   @map("html_text") @db.Text // Cached HTML content
  textExtracted    String?   @map("text_extracted") @db.Text // Extracted plain text
  fetchedAt        DateTime? @map("fetched_at")
  fetchStatus      String    @default("pending") @map("fetch_status") @db.VarChar(20) // pending, fetched, error
  fetchError       String?   @map("fetch_error") @db.Text
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  deal            Deal              @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([dealId, accessionNumber])
  @@index([dealId, filingType])
  @@index([filingDate(sort: Desc)])
  @@map("sec_filings")
}

// ============================================================================
// EDGAR REAL-TIME MONITORING SYSTEM
// ============================================================================

// All EDGAR filings detected (before M&A filtering)
model EdgarFiling {
  id                  String    @id @default(uuid()) @map("filing_id")
  accessionNumber     String    @unique @map("accession_number") @db.VarChar(50) // e.g., "0001193125-25-012345"
  cik                 String    @map("cik") @db.VarChar(10)
  companyName         String?   @map("company_name")
  ticker              String?   @db.VarChar(10)
  filingType          String    @map("filing_type") @db.VarChar(20) // 8-K, SC TO, DEFM14A, etc.
  filingDate          DateTime  @map("filing_date")
  filingUrl           String    @map("filing_url") @db.Text
  htmlUrl             String?   @map("html_url") @db.Text
  xmlUrl              String?   @map("xml_url") @db.Text

  // M&A Detection
  isMaRelevant        Boolean   @default(false) @map("is_ma_relevant")
  confidenceScore     Float?    @map("confidence_score") // 0.0 to 1.0
  detectedKeywords    String[]  @map("detected_keywords")

  // Processing status
  status              String    @default("pending") @db.VarChar(20) // pending, processed, ignored, error
  processedAt         DateTime? @map("processed_at")
  errorMessage        String?   @map("error_message") @db.Text

  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  stagedDeals         StagedDeal[]

  @@index([filingDate(sort: Desc)])
  @@index([status])
  @@index([isMaRelevant, confidenceScore])
  @@index([ticker])
  @@map("edgar_filings")
}

// Deals detected but awaiting review
model StagedDeal {
  id                    String    @id @default(uuid()) @map("staged_deal_id")

  // Deal information (extracted from filing)
  targetTicker          String?   @map("target_ticker") @db.VarChar(10)
  targetName            String    @map("target_name")
  acquirerName          String?   @map("acquirer_name")
  acquirerTicker        String?   @map("acquirer_ticker") @db.VarChar(10)
  dealValue             Decimal?  @map("deal_value") @db.Decimal(15, 2) // in billions
  dealType              String?   @map("deal_type") @db.VarChar(50) // merger, acquisition, tender_offer
  considerationType     String?   @map("consideration_type") @db.VarChar(50) // cash, stock, mixed

  // Source information
  sourceFilingId        String    @map("source_filing_id")
  sourceFilingType      String    @map("source_filing_type") @db.VarChar(20)
  detectedAt            DateTime  @default(now()) @map("detected_at")

  // Extraction metadata
  confidenceScore       Float?    @map("confidence_score")
  extractionMethod      String    @default("llm") @db.VarChar(50) // llm, regex, manual
  rawExtractedData      Json?     @map("raw_extracted_data") // Full LLM response

  // Review workflow
  status                String    @default("pending") @db.VarChar(20) // pending, approved, rejected, needs_info
  reviewedById          String?   @map("reviewed_by")
  reviewedAt            DateTime? @map("reviewed_at")
  reviewNotes           String?   @map("review_notes") @db.Text

  // Research status
  researchStatus        String    @default("queued") @db.VarChar(20) // queued, generating, completed, failed
  researchCompletedAt   DateTime? @map("research_completed_at")

  // Notification status
  alertSent             Boolean   @default(false) @map("alert_sent")
  alertSentAt           DateTime? @map("alert_sent_at")

  // If approved, link to created deal
  approvedDealId        String?   @map("approved_deal_id")

  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  sourceFiling          EdgarFiling @relation(fields: [sourceFilingId], references: [id])
  reviewedBy            User?       @relation(fields: [reviewedById], references: [id])
  researchReports       StagedDealResearch[]

  @@index([status, detectedAt(sort: Desc)])
  @@index([researchStatus])
  @@index([targetTicker])
  @@map("staged_deals")
}

// Research reports for staged deals (before approval)
model StagedDealResearch {
  id                  String    @id @default(uuid()) @map("research_id")
  stagedDealId        String    @map("staged_deal_id")
  analyzerType        String    @map("analyzer_type") @db.VarChar(50) // topping_bid, antitrust, contract
  analysisMarkdown    String    @map("analysis_markdown") @db.Text
  extractedData       Json?     @map("extracted_data")
  status              String    @default("pending") @db.VarChar(20) // pending, completed, error
  errorMessage        String?   @map("error_message") @db.Text
  generatedAt         DateTime  @default(now()) @map("generated_at")

  // Relations
  stagedDeal          StagedDeal @relation(fields: [stagedDealId], references: [id], onDelete: Cascade)

  @@index([stagedDealId, analyzerType])
  @@map("staged_deal_research")
}

// Queue for research generation
model ResearchQueue {
  id              String    @id @default(uuid()) @map("queue_id")
  stagedDealId    String    @map("staged_deal_id")

  // Queue metadata
  priority        Int       @default(5) // 1 (low) to 10 (high)
  status          String    @default("pending") @db.VarChar(20) // pending, processing, completed, failed

  // Processing info
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  attempts        Int       @default(0)
  maxAttempts     Int       @default(3) @map("max_attempts")
  errorMessage    String?   @map("error_message") @db.Text

  // Research configuration
  analyzerTypes   String[]  @map("analyzer_types") // ["topping_bid", "antitrust", "contract"]
  options         Json?     // Additional options

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([status, priority(sort: Desc), createdAt])
  @@map("research_queue")
}

// Track polling activity for monitoring
model EdgarPollingLog {
  id                      String   @id @default(uuid()) @map("log_id")
  pollTimestamp           DateTime @default(now()) @map("poll_timestamp")
  filingsFetched          Int      @map("filings_fetched")
  newFilings              Int      @map("new_filings")
  maRelevantFilings       Int      @map("ma_relevant_filings")
  errors                  Int      @default(0)
  durationMs              Int      @map("duration_ms")
  lastAccessionNumber     String?  @map("last_accession_number") @db.VarChar(50)

  @@index([pollTimestamp(sort: Desc)])
  @@map("edgar_polling_log")
}

// Main research report per deal
model DealResearchReport {
  id                    String    @id @default(uuid()) @map("report_id")
  dealId                String    @unique @map("deal_id")
  reportVersion         Int       @default(1) @map("report_version")
  generatedAt           DateTime  @default(now()) @map("generated_at")
  status                String    @default("pending") @map("status") @db.VarChar(20) // pending, generating, completed, error

  // Overall risk scores (0-100)
  antitrustRiskScore    Int?      @map("antitrust_risk_score")
  contractRiskScore     Int?      @map("contract_risk_score")
  toppingBidScore       Int?      @map("topping_bid_score") // Likelihood of topping bid
  overallRiskScore      Int?      @map("overall_risk_score")

  // Executive summary
  executiveSummary      String?   @map("executive_summary") @db.Text
  keyFindings           Json?     @map("key_findings") // Array of key findings
  redFlags              Json?     @map("red_flags") // Array of red flags
  opportunities         Json?     @map("opportunities") // Array of opportunities

  // Report metadata
  lastUpdated           DateTime  @updatedAt @map("last_updated")
  errorMessage          String?   @map("error_message") @db.Text
  processingTimeMs      Int?      @map("processing_time_ms")

  // Relations
  deal              Deal              @relation(fields: [dealId], references: [id], onDelete: Cascade)
  sections          ReportSection[]

  @@index([status])
  @@index([generatedAt(sort: Desc)])
  @@map("deal_research_reports")
}

// Individual analysis sections (antitrust, contract, topping bids, etc.)
model ReportSection {
  id                  String    @id @default(uuid()) @map("section_id")
  reportId            String    @map("report_id")
  sectionType         String    @map("section_type") @db.VarChar(50) // antitrust, contract, topping_bid, deal_structure, etc.
  sectionTitle        String    @map("section_title")

  // Analysis content
  analysisMarkdown    String    @map("analysis_markdown") @db.Text // Markdown formatted analysis
  riskScore           Int?      @map("risk_score") // 0-100 section-specific risk score
  confidence          String?   @map("confidence") @db.VarChar(20) // high, medium, low

  // Structured data extracted
  extractedData       Json?     @map("extracted_data") // Section-specific structured data
  keyPoints           Json?     @map("key_points") // Array of key points

  // Source tracking
  sourceFilingIds     String[]  @map("source_filing_ids") // Array of filing IDs used
  aiModel             String?   @map("ai_model") @db.VarChar(50) // claude-3-5-sonnet, etc.
  promptVersion       String?   @map("prompt_version") @db.VarChar(20) // Track prompt versions

  // Metadata
  generatedAt         DateTime  @default(now()) @map("generated_at")
  status              String    @default("pending") @map("status") @db.VarChar(20) // pending, completed, error
  errorMessage        String?   @map("error_message") @db.Text
  processingTimeMs    Int?      @map("processing_time_ms")

  // Relations
  report        DealResearchReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, sectionType])
  @@index([sectionType])
  @@map("report_sections")
}
