generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  username           String?             @unique
  email              String              @unique
  password           String
  fullName           String?             @map("full_name")
  alias              String?             @unique  // Display name like "DR3", "KRJ", etc.
  role               String              @default("analyst")
  isActive           Boolean             @default(true) @map("is_active")
  mustChangePassword Boolean             @default(false) @map("must_change_password")
  lastLoginAt        DateTime?           @map("last_login_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  projectAccess      String[]            @default(["krj", "ma-options", "sheet-portfolio"]) @map("project_access")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  apiPriceFetches    ApiPriceFetch[]
  auditLogs          AuditLog[]
  dealSnapshots      DealSnapshot[]
  dealVersions       DealVersion[]
  dealsCreated       Deal[]              @relation("DealsCreated")
  dealsUpdated       Deal[]              @relation("DealsUpdated")
  portfolioPositions PortfolioPosition[]
  curatedSpreads     WatchedSpread[]
  preferences        UserPreferences?
  
  // KRJ ticker list relationships
  ownedKrjLists      KrjTickerList[]     @relation("OwnedLists")
  addedKrjTickers    KrjTicker[]
  krjListForks       KrjTickerListFork[]
  krjPreferences     UserKrjPreferences?
  
  // Deal list relationships
  userDealLists      UserDealList[]
  addedScannerDeals  ScannerDeal[]

  @@map("users")
}

model Deal {
  id                   String                @id @default(uuid()) @map("deal_id")
  ticker               String
  targetName           String?               @map("target_name")
  acquirorTicker       String?               @map("acquiror_ticker")
  acquirorName         String?               @map("acquiror_name")
  status               String                @default("active")
  noOptionsAvailable   Boolean               @default(false) @map("no_options_available")
  lastOptionsCheck     DateTime?             @map("last_options_check")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  createdById          String?               @map("created_by")
  updatedById          String?               @map("updated_by")
  cvrs                 Cvr[]
  prices               DealPrice[]
  snapshots            DealSnapshot[]
  versions             DealVersion[]
  createdBy            User?                 @relation("DealsCreated", fields: [createdById], references: [id])
  updatedBy            User?                 @relation("DealsUpdated", fields: [updatedById], references: [id])
  optionChainSnapshots OptionChainSnapshot[]
  portfolioPositions   PortfolioPosition[]

  @@index([ticker])
  @@index([status])
  @@map("deals")
}

model DealVersion {
  id                 String    @id @default(uuid()) @map("version_id")
  dealId             String    @map("deal_id")
  versionNumber      Int       @map("version_number")
  effectiveDate      DateTime  @default(now()) @map("effective_date")
  isCurrentVersion   Boolean   @default(true) @map("is_current_version")
  announcedDate      DateTime? @map("announced_date") @db.Date
  expectedCloseDate  DateTime? @map("expected_close_date") @db.Date
  outsideDate        DateTime? @map("outside_date") @db.Date
  category           String?   @db.VarChar(50)
  cashPerShare       Decimal?  @map("cash_per_share") @db.Decimal(10, 4)
  stockRatio         Decimal?  @map("stock_ratio") @db.Decimal(10, 6)
  dividendsOther     Decimal?  @map("dividends_other") @db.Decimal(10, 4)
  stressTestDiscount Decimal?  @map("stress_test_discount") @db.Decimal(5, 4)
  voteRisk           String?   @map("vote_risk") @db.VarChar(20)
  financeRisk        String?   @map("finance_risk") @db.VarChar(20)
  legalRisk          String?   @map("legal_risk") @db.VarChar(20)
  currentYield       Decimal?  @map("current_yield") @db.Decimal(10, 6)
  isInvestable       Boolean   @default(false) @map("is_investable")
  investableNotes    String?   @map("investable_notes")
  dealNotes          String?   @map("deal_notes")
  goShopEndDate      DateTime? @map("go_shop_end_date") @db.Date
  createdById        String?   @map("created_by")
  createdBy          User?     @relation(fields: [createdById], references: [id])
  deal               Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([dealId, versionNumber])
  @@index([dealId, isCurrentVersion])
  @@index([effectiveDate])
  @@map("deal_versions")
}

model DealPrice {
  id            String   @id @default(uuid()) @map("price_id")
  dealId        String   @map("deal_id")
  priceDate     DateTime @map("price_date") @db.Date
  targetPrice   Decimal  @map("target_price") @db.Decimal(10, 4)
  acquirorPrice Decimal? @map("acquiror_price") @db.Decimal(10, 4)
  source        String   @default("interactive_brokers") @db.VarChar(50)
  createdAt     DateTime @default(now()) @map("created_at")
  deal          Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([dealId, priceDate])
  @@index([dealId, priceDate(sort: Desc)])
  @@index([priceDate(sort: Desc)])
  @@map("deal_prices")
}

model Cvr {
  id              String    @id @default(uuid()) @map("cvr_id")
  dealId          String    @map("deal_id")
  cvrName         String?   @map("cvr_name") @db.VarChar(255)
  paymentAmount   Decimal   @map("payment_amount") @db.Decimal(10, 4)
  probability     Decimal   @default(0.50) @db.Decimal(3, 2)
  paymentDeadline DateTime? @map("payment_deadline") @db.Date
  paymentStatus   String    @default("pending") @map("payment_status") @db.VarChar(50)
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deal            Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([paymentStatus])
  @@map("cvrs")
}

model PortfolioPosition {
  id          String         @id @default(uuid()) @map("position_id")
  dealId      String         @map("deal_id")
  shares      Decimal        @db.Decimal(15, 4)
  entryDate   DateTime       @map("entry_date") @db.Date
  entryPrice  Decimal        @map("entry_price") @db.Decimal(10, 4)
  exitDate    DateTime?      @map("exit_date") @db.Date
  exitPrice   Decimal?       @map("exit_price") @db.Decimal(10, 4)
  status      String         @default("open") @db.VarChar(50)
  notes       String?
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  createdById String?        @map("created_by")
  snapshots   DealSnapshot[]
  createdBy   User?          @relation(fields: [createdById], references: [id])
  deal        Deal           @relation(fields: [dealId], references: [id])

  @@index([dealId])
  @@index([status])
  @@map("portfolio_positions")
}

model DealSnapshot {
  id               String             @id @default(uuid()) @map("snapshot_id")
  dealId           String             @map("deal_id")
  snapshotType     String             @map("snapshot_type") @db.VarChar(50)
  snapshotDate     DateTime           @default(now()) @map("snapshot_date")
  targetPrice      Decimal?           @map("target_price") @db.Decimal(10, 4)
  acquirorPrice    Decimal?           @map("acquiror_price") @db.Decimal(10, 4)
  dealPrice        Decimal?           @map("deal_price") @db.Decimal(10, 4)
  grossSpread      Decimal?           @map("gross_spread") @db.Decimal(10, 6)
  netSpread        Decimal?           @map("net_spread") @db.Decimal(10, 6)
  daysToClose      Int?               @map("days_to_close")
  annualizedReturn Decimal?           @map("annualized_return") @db.Decimal(10, 6)
  projectedIrr     Decimal?           @map("projected_irr") @db.Decimal(10, 6)
  cvrTotalNpv      Decimal?           @map("cvr_total_npv") @db.Decimal(10, 4)
  notes            String?
  createdById      String?            @map("created_by")
  positionId       String?            @map("position_id")
  createdBy        User?              @relation(fields: [createdById], references: [id])
  deal             Deal               @relation(fields: [dealId], references: [id])
  position         PortfolioPosition? @relation(fields: [positionId], references: [id])

  @@index([dealId])
  @@index([snapshotType])
  @@index([snapshotDate(sort: Desc)])
  @@map("deal_snapshots")
}

model ApiPriceFetch {
  id               String    @id @default(uuid()) @map("fetch_id")
  fetchDate        DateTime  @map("fetch_date") @db.Date
  ticker           String    @db.VarChar(10)
  fetchStatus      String?   @map("fetch_status") @db.VarChar(50)
  recordsFetched   Int       @default(0) @map("records_fetched")
  errorMessage     String?   @map("error_message")
  fetchStartedAt   DateTime  @default(now()) @map("fetch_started_at")
  fetchCompletedAt DateTime? @map("fetch_completed_at")
  createdById      String?   @map("created_by")
  createdBy        User?     @relation(fields: [createdById], references: [id])

  @@index([fetchDate(sort: Desc)])
  @@index([ticker])
  @@map("api_price_fetches")
}

model AuditLog {
  id            String   @id @default(uuid()) @map("log_id")
  entityType    String   @map("entity_type") @db.VarChar(50)
  entityId      String   @map("entity_id")
  action        String   @db.VarChar(20)
  changedFields String?  @map("changed_fields")
  oldValues     String?  @map("old_values")
  newValues     String?  @map("new_values")
  createdAt     DateTime @default(now()) @map("created_at")
  createdById   String?  @map("created_by")
  createdBy     User?    @relation(fields: [createdById], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@index([createdById])
  @@map("audit_logs")
}

model OptionChainSnapshot {
  id              String    @id @default(uuid())
  dealId          String    @map("deal_id")
  ticker          String
  snapshotDate    DateTime  @default(now()) @map("snapshot_date")
  agentId         String?   @map("agent_id")
  agentTimestamp  DateTime? @map("agent_timestamp")
  spotPrice       Decimal   @map("spot_price") @db.Decimal(10, 4)
  dealPrice       Decimal   @map("deal_price") @db.Decimal(10, 4)
  daysToClose     Int       @map("days_to_close")
  chainData       Json      @map("chain_data")
  expirationCount Int       @map("expiration_count")
  strikeCount     Int       @map("strike_count")
  createdAt       DateTime  @default(now()) @map("created_at")
  deal            Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([ticker])
  @@index([snapshotDate])
  @@index([ticker, snapshotDate(sort: Desc)])
  @@map("option_chain_snapshots")
}

model WatchedSpread {
  id              String      @id @default(uuid())
  scannerDealId   String      @map("scanner_deal_id")
  curatedBy       String?     @map("curated_by")
  strategyType    String      @map("strategy_type")
  expiration      DateTime    @db.Date
  legs            Json
  entryPremium    Decimal     @map("entry_premium") @db.Decimal(10, 4)
  entryDate       DateTime    @default(now()) @map("entry_date")
  maxProfit       Decimal     @map("max_profit") @db.Decimal(10, 4)
  maxLoss         Decimal     @map("max_loss") @db.Decimal(10, 4)
  returnOnRisk    Decimal     @map("return_on_risk") @db.Decimal(10, 4)
  annualizedYield Decimal     @map("annualized_yield") @db.Decimal(10, 4)
  currentPremium  Decimal?    @map("current_premium") @db.Decimal(10, 4)
  underlyingPrice Decimal?    @map("underlying_price") @db.Decimal(10, 4)
  lastUpdated     DateTime?   @map("last_updated")
  avgBidAskSpread Decimal?    @map("avg_bid_ask_spread") @db.Decimal(10, 6)
  avgVolume       Int?        @map("avg_volume")
  avgOpenInterest Int?        @map("avg_open_interest")
  status          String      @default("active")
  isPublic        Boolean     @default(true) @map("is_public") // Visible in community view
  notes           String?
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  curator         User?       @relation(fields: [curatedBy], references: [id])
  scannerDeal     ScannerDeal @relation(fields: [scannerDealId], references: [id], onDelete: Cascade)
  userListItems   UserDealListItem[]

  @@index([scannerDealId])
  @@index([status])
  @@index([expiration])
  @@index([curatedBy])
  @@map("watched_spreads")
}

model ScannerDeal {
  id                 String          @id @default(uuid())
  ticker             String          @unique
  targetName         String?         @map("target_name")
  expectedClosePrice Decimal         @map("expected_close_price") @db.Decimal(10, 4)
  expectedCloseDate  DateTime        @map("expected_close_date") @db.Date
  notes              String?
  isActive           Boolean         @default(true) @map("is_active")
  noOptionsAvailable Boolean         @default(false) @map("no_options_available")
  lastOptionsCheck   DateTime?       @map("last_options_check")
  addedById          String?         @map("added_by")
  addedBy            User?           @relation(fields: [addedById], references: [id])
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  watchedSpreads     WatchedSpread[]

  @@index([isActive])
  @@index([ticker])
  @@index([addedById])
  @@map("scanner_deals")
}

model AgentApiKey {
  id        String    @id @default(uuid())
  userId    String    @unique @map("user_id")
  key       String    @unique
  createdAt DateTime  @default(now()) @map("created_at")
  lastUsed  DateTime? @map("last_used")

  @@index([key])
  @@map("agent_api_keys")
}

model UserPreferences {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Dashboard preferences (JSON for flexibility)
  maOptionsPrefs Json?    @map("ma_options_prefs")
  dealListPrefs  Json?    @map("deal_list_prefs")
  
  // UI preferences: density mode, column visibility, etc.
  uiPrefs        Json?    @map("ui_prefs")
  
  // Ticker watchlists
  customTickers  String[] @map("custom_tickers")
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  @@map("user_preferences")
}

// Email whitelist for signup - only whitelisted emails can create accounts
model EmailWhitelist {
  id        String   @id @default(uuid())
  email     String   @unique
  addedBy   String?  @map("added_by")
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("email_whitelist")
}

// ============================================
// KRJ Ticker List Models
// ============================================

model KrjTickerList {
  id          String              @id @default(uuid())
  name        String              // "Top Equities", "SP500", "DRC", etc.
  slug        String              @unique // "equities", "sp500", "drc"
  description String?
  ownerId     String?             @map("owner_id")
  owner       User?               @relation("OwnedLists", fields: [ownerId], references: [id])
  isSystem    Boolean             @default(false) @map("is_system") // true for SP500/SP100 (auto-updated from index)
  isEditable  Boolean             @default(true) @map("is_editable") // false for system lists
  displayOrder Int                @default(0) @map("display_order")
  tickers     KrjTicker[]
  forks       KrjTickerListFork[]
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  @@index([ownerId])
  @@index([slug])
  @@map("krj_ticker_lists")
}

model KrjTicker {
  id        String        @id @default(uuid())
  listId    String        @map("list_id")
  list      KrjTickerList @relation(fields: [listId], references: [id], onDelete: Cascade)
  ticker    String
  addedById String?       @map("added_by")
  addedBy   User?         @relation(fields: [addedById], references: [id])
  addedAt   DateTime      @default(now()) @map("added_at")
  position  Int           @default(0)
  
  @@unique([listId, ticker])
  @@index([listId])
  @@index([ticker])
  @@map("krj_tickers")
}

model KrjTickerListFork {
  id             String        @id @default(uuid())
  sourceListId   String        @map("source_list_id")
  sourceList     KrjTickerList @relation(fields: [sourceListId], references: [id], onDelete: Cascade)
  userId         String        @map("user_id")
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedTickers   String[]      @map("added_tickers")   // Tickers user added to their fork
  removedTickers String[]      @map("removed_tickers") // Tickers user hid from their view
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  
  @@unique([sourceListId, userId])
  @@index([userId])
  @@map("krj_ticker_list_forks")
}

model UserKrjPreferences {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  hiddenListIds String[] @map("hidden_list_ids") // List IDs the user doesn't want to see
  tabOrder      String[] @map("tab_order")       // Custom tab ordering (list IDs)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@map("user_krj_preferences")
}

// ============================================
// User Deal List Models
// ============================================

model UserDealList {
  id        String             @id @default(uuid())
  userId    String             @map("user_id")
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String             // "My Focus List", "High Conviction", etc.
  isDefault Boolean            @default(false) @map("is_default") // One default list per user
  items     UserDealListItem[]
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  @@index([userId])
  @@map("user_deal_lists")
}

model UserDealListItem {
  id        String        @id @default(uuid())
  listId    String        @map("list_id")
  list      UserDealList  @relation(fields: [listId], references: [id], onDelete: Cascade)
  spreadId  String        @map("spread_id")
  spread    WatchedSpread @relation(fields: [spreadId], references: [id], onDelete: Cascade)
  addedAt   DateTime      @default(now()) @map("added_at")
  notes     String?

  @@unique([listId, spreadId])
  @@index([listId])
  @@index([spreadId])
  @@map("user_deal_list_items")
}
