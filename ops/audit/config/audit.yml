# DR3 Audit Configuration
version: 1

schedule:
  weekly_scan_day: 0  # 0=Sunday
  retention_days: 30
  check_timeout_seconds: 120

thresholds:
  disk_warn_pct: 85
  disk_alert_pct: 95
  memory_warn_pct: 80
  container_restart_alert: 3
  failed_ssh_alert: 100
  spread_alert_threshold_pct: 2.0

allowed_ports:
  public:
    - {port: 443, process: "caddy", note: "HTTPS via Cloudflare"}
    - {port: 80, process: "caddy", note: "HTTP redirect"}
    - {port: 22, process: "sshd", note: "SSH"}
    - {port: 3000, process: "node", note: "Next.js web (Docker)"}
    - {port: 5432, process: "postgres", note: "PostgreSQL (Docker) — TODO: bind to 127.0.0.1"}
    - {port: 8000, process: "python", note: "Trading service (bare-metal)"}
  localhost:
    - {port: 3000, process: "node", note: "Next.js web"}
    - {port: 5432, process: "postgres", note: "PostgreSQL"}
    - {port: 8000, process: "python", note: "Trading service"}
    - {port: 8001, process: "python", note: "Portfolio service"}
    - {port: 2019, process: "caddy", note: "Caddy admin API"}
    - {port: 53, process: "systemd-resolved", note: "DNS resolver"}

expected_containers:
  always_running: ["ma-tracker-app-web", "python-portfolio", "ma-tracker-postgres"]
  on_demand: ["krj-batch"]

containers_allowed_root: ["ma-tracker-postgres"]

external_url: "https://dr3-dashboard.com"

database:
  name: "ma_tracker"
  container: "ma-tracker-postgres"
  user: "ma_user"

expected_scheduler_jobs:
  - morning_sheet_ingest
  - morning_detail_refresh
  - overnight_event_scan
  - morning_risk_assessment
  - morning_report_compile
  - morning_report_deliver
  - edgar_filing_check
  - spread_monitor_tick
  - after_hours_summary
  - options_opportunity_check
  - weekly_cleanup

alert:
  recipients:
    email: []  # configure with actual emails
  sendgrid_env_var: "SENDGRID_API_KEY"
  from_email: "audit@dr3-dashboard.com"

weekly_only_checks:
  - "app/bandit_scan"
  - "app/eslint_security"

suppressions:
  - check: "app/npm_audit"
    id: "npm_not_installed"
    reason: "npm not available on bare-metal droplet — Node runs inside Docker only"
    expires: "2027-01-01"
